"""
Property-based test for Repair Advisor damage hotspot coordinates.

Feature: code-quality-validation, Property 9: Damage Hotspot Coordinates
Validates: Requirements 6.3
"""
import pytest
from hypothesis import given, settings, strategies as st
from unittest.mock import AsyncMock, patch
from datetime import datetime

import sys
sys.path.insert(0, '.')
from main import PhysicalRepairAdvisorAgent, DamageHotspot
from tests.generators import arbitrary_text, arbitrary_confidence


@pytest.mark.property
@pytest.mark.asyncio
@settings(max_examples=100, deadline=None)
@given(
    raw_text=arbitrary_text(min_length=20, max_length=300),
    ocr_conf=arbitrary_confidence()
)
async def test_damage_hotspot_coordinates_within_bounds(raw_text, ocr_conf):
    """
    Feature: code-quality-validation, Property 9: Damage Hotspot Coordinates
    Validates: Requirements 6.3
    
    Property: For any DamageHotspot generated by the Repair Advisor, the x and y 
    coordinates should be between 0 and 100 (representing percentages).
    """
    advisor = PhysicalRepairAdvisorAgent()
    context = {
        "raw_text": raw_text,
        "ocr_confidence": ocr_conf,
        "image_data": b"fake_image_data",
        "start_time": datetime.utcnow()
    }
    
    # Mock AI calls
    with patch.object(advisor, '_get_ai_damage_analysis', new_callable=AsyncMock) as mock_ai:
        mock_ai.return_value = None
        
        # Process
        messages = []
        async for message in advisor.process(context):
            messages.append(message)
        
        # PROPERTY: All hotspots must have coordinates in range [0, 100]
        hotspots = context.get("damage_hotspots", [])
        
        for hotspot in hotspots:
            assert isinstance(hotspot, DamageHotspot), "Must be DamageHotspot instance"
            assert 0 <= hotspot.x <= 100, f"Hotspot x={hotspot.x} must be in [0, 100]"
            assert 0 <= hotspot.y <= 100, f"Hotspot y={hotspot.y} must be in [0, 100]"
